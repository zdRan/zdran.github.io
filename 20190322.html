<html >
	<head>
		<meta charset="utf-8">
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
		<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
		<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
		
		<link href="https://cdn.bootcdn.net/ajax/libs/vuetify/2.6.12/vuetify.min.css" rel="stylesheet">
		<script src="https://cdn.bootcdn.net/ajax/libs/vuetify/2.0.4/vuetify.min.js"></script>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/rainbow.min.css">
		<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
		<link href="https://cdn.bootcdn.net/ajax/libs/MaterialDesign-Webfont/6.9.96/css/materialdesignicons.min.css" rel="stylesheet">
		<link href="/css/three-cards-style.css" rel="stylesheet">

		<meta name="robots" contect= "all">
		<meta name="description" contect="一个热爱学习的 Java 程序员,喜欢 Vue,喜欢深度学习">
		<!-- 主页使用 category作为 keywords,文章页使用文章的 keywords -->
		
		<meta name="keywords" contect="java,JVM,Java,内存划分">
		 
		<link rel="icon shortcut" type="image/ico" href=/images/favicon.jpg>
		<title>
			U2647's blog
		</title>
		<!-- 百度统计 -->
		
		<!-- Google Search Console -->
		
	<meta name="generator" content="Hexo 6.3.0"></head>
	<body>
		<div id="app">
			<v-app>
				<!-- 页头 -->
				<v-card tile elevation="24"  style="width: 80%; margin: 0 auto; text-align:center; background:rgba(0,0,0,0); margin-bottom: 3%;" gradient="to bottom, rgba(0,0,0,.1), rgba(0,0,0,.5)">
	<v-img height="240" src="" class="white--text align-end" >
		<v-card-title style="text-align: left; margin-left: 0.3%;">U2647's blog</v-card-title>
		<v-card-text style="text-align: left;margin-left: 0.3%;" class="white--text">
			一个热爱学习的 Java 程序员,喜欢 Vue,喜欢深度学习
		</v-card-text>
		<v-divider style="margin-left: 1.3%; margin-right: 1.3%;" class="success lighten-1"></v-divider>
		<v-card-text style="text-align: left;" class="white--text">
			
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/Dubbo">Dubbo</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/Flutter">Flutter</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/SpringBoot">SpringBoot</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/Debug">Debug</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/Notes">Notes</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/Java">Java</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/LeetCode">LeetCode</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/Python">Python</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/Redis">Redis</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/Android">Android</v-btn>
					
					<v-btn text class="white--text" style="text-transform:capitalize;" href="/categories/DesignPattern">DesignPattern</v-btn>
				
			
		</v-card-text>
	</v-img>
	<v-divider style="margin-left: 1.3%; margin-right: 1.3%;" class="success lighten-1"></v-divider>
	<v-card-actions >
		
			<v-btn text x-large class="white--text" style="margin-left: 0.5%;margin-top:0.5%;margin-bottom: 0.5%;" href=/>
				<v-icon right>
					mdi-home-outline
				</v-icon>
				首页
			</v-btn>
		
			<v-btn text x-large class="white--text" style="margin-left: 0.5%;margin-top:0.5%;margin-bottom: 0.5%;" href=/tags>
				<v-icon right>
					mdi-cloud-outline
				</v-icon>
				标签云
			</v-btn>
		
			<v-btn text x-large class="white--text" style="margin-left: 0.5%;margin-top:0.5%;margin-bottom: 0.5%;" href=/timeline>
				<v-icon right>
					mdi-timeline-text-outline
				</v-icon>
				时间轴
			</v-btn>
		
		<v-spacer></v-spacer>
		<v-btn text x-large class="white--text" style="margin-left: 0.5%;margin-top:0.5%;margin-bottom: 0.5%;">
			<v-icon right>
			mdi-draw-pen
			</v-icon>
			文章总数  
	  	</v-btn >
		<v-btn icon style="margin-right: 0.5%;margin-top:0.5%;margin-bottom: 0.5%;">
			<v-avatar color="success" size="35" >
				<span class="white--text"> 62 </span>
			</v-avatar>
		</v-btn>
	  </v-card-actions>
</v-card>
 
				<div style="width: 55%; margin: 0 auto; text-align:center;">
					<v-card tile max-width="100%" elevation="24" style="margin-bottom: 3%;" >
    <v-img height="240" class="white--text align-end" src=/random/material-23.jpg gradient="to bottom, rgba(0,0,0,.1), rgba(0,0,0,.5)">
        <v-card-title style="text-align: left;margin-left: 0.6%;">
            <span>JVM 读书笔记(一) 内存划分</span>
        </v-card-title>
    <v-card-text style="text-align: left;margin-left: 0.8%;">
        JVM 读书笔记(一) 内存划分
    </v-card-text>
    <v-divider class="success lighten-1" style="margin-left:2%; margin-right: 2%;"></v-divider>
    <v-card-actions style="text-align: left;" class="white--text" style="margin-left:2%; margin-right: 2%;">
        
            	
                <v-btn text class="white--text" style="text-transform:capitalize;margin-left:0.5%;">JVM</v-btn>
            	
                <v-btn text class="white--text" style="text-transform:capitalize;margin-left:0.5%;">Java</v-btn>
            	
                <v-btn text class="white--text" style="text-transform:capitalize;margin-left:0.5%;">内存划分</v-btn>
            
        
        <v-spacer></v-spacer>
		<v-btn text class="white--text" >
			<v-icon right>
			mdi-cursor-default-click-outline
			</v-icon>
			点击量
	  	</v-btn >
		<v-btn icon >
			<v-avatar color="success" size="35" >
				<span id = "busuanzi_value_page_pv" class="white--text"> 62 </span>
			</v-avatar>
		</v-btn>
    </v-card-actions>
    </v-img>    
    <v-card-text>
        <div id = "post_container" class="text-justify" style="padding-left: 2%;padding-right: 2%;padding-bottom: 2%">
            <ul>
<li><a href="https://zdran.com/20190322.html">JVM 读书笔记(一) 内存划分</a></li>
<li><a href="https://zdran.com/20190912.html">JVM 读书笔记(二) 垃圾收集</a></li>
</ul>
<h2 id="0-引言"><a href="#0-引言" class="headerlink" title="0. 引言"></a>0. 引言</h2><p>Java 在运行时会将内存划分为若干个区域，粗略的可以将内存划分为堆区和栈区，堆区主要存储 Java 对象。栈区主要记录对象的引用地址。</p>
<p>其实还有更详细的划分。如下图所示：</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gmpwvv4dfsj30r40gu0to.jpg" alt="20190321-1"></p>
<h2 id="1-Java-虚拟机栈"><a href="#1-Java-虚拟机栈" class="headerlink" title="1. Java 虚拟机栈"></a>1. Java 虚拟机栈</h2><p>Java 虚拟机栈就是我们之前将内存分为堆区和栈区，这里的栈区就是指的 Java 虚拟机栈。</p>
<p>每个方法在执行的同时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链表、方法出口信息等。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。主要用来存储局部变量表。</p>
<p>在这个区域会抛出两个异常，如果请求的栈的深度超过了虚拟机允许的最大深度，会抛出 StackOverflowError ,如果无法申请到足够的内存会抛出 OutOfMemoryError 异常。</p>
<h2 id="2-本地方法栈"><a href="#2-本地方法栈" class="headerlink" title="2. 本地方法栈"></a>2. 本地方法栈</h2><p>与 Java 虚拟机栈类似，本地方法栈是服务于 Native 方法的。为本地方法提供内存，同样也会抛出 StackOverflowError、OutOfMemoryError 异常。</p>
<h2 id="3-程序计数器"><a href="#3-程序计数器" class="headerlink" title="3. 程序计数器"></a>3. 程序计数器</h2><p>程序计数器可以看做当前线程所执行的字节码的行号计数器。字节码的解释器需要通过改变这个值来选取下一条需要执行的字节码指令。程序中的分支、循环，跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。</p>
<h2 id="4-方法区"><a href="#4-方法区" class="headerlink" title="4. 方法区"></a>4. 方法区</h2><p>方法区是用来存放 JVM 装载的 class 的类信息，包括：类的方法、静态变量、类型信息(接口&#x2F;父类)，我们使用反射，所需的信息就是从这里获取的。同样的，当方法区无法满足内存需要的时候会抛出 OutOfMemoryError 。</p>
<h2 id="4-1-运行时常量池"><a href="#4-1-运行时常量池" class="headerlink" title="4.1 运行时常量池"></a>4.1 运行时常量池</h2><p>常量池是方法区的一部分，用于记录编译期生成的各种字面量和符号引用。在 Java 类中使用 final 标识的字段都会放到常量池里。常量池在运行时不是一成不变的。常见的场景是 String 类的 intern 方法。当调用该方法时，JVM 会判断常量池里是否有该对象，有的话直接返回，没有的话，需要把该字符串放入常量池然后再返回。</p>
<h2 id="5-Java-堆"><a href="#5-Java-堆" class="headerlink" title="5. Java 堆"></a>5. Java 堆</h2><p>右边橙色部分的区域都是 Java 堆。这部分内存是 Java 虚拟机里最大的内存区域。我们之前将内存粗略的划分为堆区和栈区，其中栈区指的是 Java 虚拟机栈，而堆区说的就是 Java 堆。所有的 Java 对象都是在这个区域分配的内存，虚拟机的 GC 动作 大部分都是在这个区域进行的。 </p>
<p>再细分一下可以将 Java 堆分为新生代和老年代。新生代又可以分为 From Survivor 区、To Survivor 区、Eden 区。</p>
<p>新生代的 Eden 区、From Survivor 区、To Survivor 区的比值是 8:1:1。</p>
<p>对象在第一次创建的时候会在新生代分配内存。准确的说是在 Eden 区分配内存。 经过一次 GC 后，没有被回收的对象年龄加 1 并且会从 Eden 区、From Survivor 区转移到 To Survivor 区。 To Survivor 区会成为新的 From Survivor 区。 同样 From Survivor 区会成为新的 To Survivor 区。</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gmpww1n9rmj30q60j8gm7.jpg" alt="20190321-2"></p>
<p>当年龄超过一定的值后（默认15）会将该对象转移到老年代。</p>
<p><strong>PS:并不是所有对象在第一次创建的时候都会在新生代分配内存，有些对象大到超过新生代的内存时，会直接在老年代分配内存</strong></p>
<h2 id="6-一个对象的诞生"><a href="#6-一个对象的诞生" class="headerlink" title="6. 一个对象的诞生"></a>6. 一个对象的诞生</h2><p>当 JVM 通过程序计数器的行号读取到一条 new 指令的时候，首先会去方法区寻找这个类是否被加载、解析、初始化过，如果没有的话需要先进行类的加载。</p>
<p>类被加载之后需要在 Java 堆中分配内存，如果 Java 堆中的内存是非常规整的，记录着使用和未使用区域的分界线，那么内存分配仅仅是将分界线向没有使用的内存方向移动一段距离就可以了。这种方式称为”指针碰撞”。如果内存并不是规整的，那么虚拟机就需要单独维护一个列表，用来记录哪些内存是可用的。在分配的时候通过这个列表找到足够大的一块内存分配给该对象。这种方式称为”空闲列表”。</p>
<p>这里还需要注意一个并发的问题。如果 A 对象正在分配内存，指针位置还没有来得及修改，B 对象又从原来的位置开始分配内存。</p>
<p>为了解决这个问题，有两种方案。一种是将内存分配进行同步处理。保证内存分配的原子性。另外一种解决方式是根据线程的不同，将分配内存的动作划分到不同的区域。每个线程都在自己的内存区域申请内存。这个区域称为本地线程分配缓冲(TLAB)。当这部分区域的内存不够时再进行同步申请新的区域。</p>
<p>内存分配完成后，虚拟机将内存初始化为 0 值，一些属性的默认值都是在这一步赋值的。比如 int 类型、boolean 类型的默认值等。</p>
<p>然后需要对对象进行必要的设置。比如说对象的年龄、对象的哈希值、对象的类的信息等。这部分数据保存在对象头中</p>
<h2 id="7-对象的访问"><a href="#7-对象的访问" class="headerlink" title="7. 对象的访问"></a>7. 对象的访问</h2><p>对象创建结束后，有两种方式来访问我们创建的对象。使用句柄和直接指针。</p>
<h3 id="7-1-使用句柄访问。"><a href="#7-1-使用句柄访问。" class="headerlink" title="7.1 使用句柄访问。"></a>7.1 使用句柄访问。</h3><p>如果使用句柄访问的话虚拟机会多划出一块内存用来做句柄池。Java 虚拟机栈中记录的就是对象的句柄地址。如下图所示：</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gmpwwcmr4lj30sn0lc0tn.jpg" alt="20190321-3"></p>
<h3 id="7-2-直接指针访问"><a href="#7-2-直接指针访问" class="headerlink" title="7.2 直接指针访问"></a>7.2 直接指针访问</h3><p>使用直接指针访问时，Java 虚拟机的栈中记录的是对象在 Java 堆中的直接地址。如下图所示：</p>
<p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gmpwwjvymbj30ro0k70th.jpg" alt="20190321-4"></p>
<p>这两种方式各有优点，使用句柄访问时在对象移动的时候（GC时）只需要改变句柄的值就可以了，而 Java 栈中的引用地址可以不用改变。</p>
<p>直接指针方式最大的好处就是速度快，它减少了一次指针定位的时间开销。</p>
<h2 id="8-参考"><a href="#8-参考" class="headerlink" title="8. 参考"></a>8. 参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/24722612/">深入理解Java虚拟机（第2版）</a></li>
</ul>

        </div>
    </v-card-text>
    <v-divider class="success lighten-1" ></v-divider>
    <v-card-text>
        <v-alert style="margin-left:2%; margin-right: 2%;padding-top: 2%;padding-bottom: 2%;" dense text border="left" type="success">
            版权声明：本博客所有文章除特别声明外，均采用 <a href="/creativecommons.html" target="_blank">CC BY-NC-SA 4.0 </a>许可协议。转载请注明出处！
        </v-alert>
    </v-card-text>
</v-card>
  
					<!-- 分页 -->
					
				</div>
				<!-- 页脚 -->
				<div style="width: 100%; margin-top: 2%; text-align:center;">
	<v-footer padless style="background:rgba(76,175,80,0.4);">
    <v-card style="width: 100%; text-align:center;background:rgba(0,0,0,0);" gradient="to top, rgba(0,0,0,.2), rgba(0,0,0,.8)" tile elevation="24" class="white--text text-center">
      <v-card-actions style="text-align: center;">
		
			<v-chip  class="white--text" style="background:rgba(0,0,0,0);" href=https://github.com/zdRan>
				我的GitHub
			</v-chip>
		
			<v-chip  class="white--text" style="background:rgba(0,0,0,0);" href=https://leetcode.cn/u/u2647>
				我的LeetCode
			</v-chip>
		
			<v-chip  class="white--text" style="background:rgba(0,0,0,0);" href=https://juejin.cn/user/3896324938793943>
				我的掘金
			</v-chip>
		
		<v-spacer></v-spacer>
		<div>
			<v-list-item two-line>
				<!-- 很高兴您使用本主题，开发不易，希望您保留一下版权声明，它并不会影响页面效果 ~ -->
				<v-list-item-content style="text-align: left;display: inline-block;">
					<v-list-item-subtitle class="white--text">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="color: white;"><strong>Hexo</strong></a></v-list-item-subtitle>
					<v-list-item-subtitle class="white--text">Powered by <a target="_blank" rel="noopener" href="https://github.com/zdRan/three-cards" style="color: white;"><strong>three-cards</strong></a></v-list-item-subtitle>
				</v-list-item-content>
			</v-list-item>
		</div>
      </v-card-actions>
      <v-divider class="success lighten-1"></v-divider>
      <v-card-text class="white--text">
    	Copyright © 2017 - {{ new Date().getFullYear() }}  <a target="_blank" href="http://www.miitbeian.gov.cn" rel="nofollow noopener" style="color: white;">某ICP备xxxxxxxx号</a>
      </v-card-text>
    </v-card>
  </v-footer>
</div> 
			</v-app>			
		</div>
        <script>
        	new Vue({
            	el: '#app',
            	vuetify: new Vuetify(),
          	});
			//加载代码高亮
			hljs.highlightAll();
        </script>
    </body>
</html>